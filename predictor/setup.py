import os
import subprocess
import json
import argh

@argh.arg('--kFold', '-k', help='Specify if kfold setup is needed')
def get_repos(kFold=False):
    if kFold:
        k = 10
    else:
        k = 1
    BASEDIR = os.getcwd()
    for i in range(1,k+1):
        with open('./targets'+('' if k==1 else str(i))+'.json', 'r') as fp:
            targets = json.load(fp)
        if not os.path.isdir('./tests/repos'):
            os.mkdir('./tests/repos')

        os.chdir('./tests/repos')

        REPODIR = os.getcwd()

        paths = list()

        for target in targets:
            if not os.path.isdir(target['commit_hash']):
                os.mkdir(target['commit_hash'])
                os.chdir(target['commit_hash'])
                subprocess.run(['git', 'clone', target['git_path']])
                os.chdir(target['target_file_path'].split('/')[0])
                subprocess.run(['git', 'checkout', target['parent_hash']])
                os.chdir(REPODIR)
            
            paths.append('/'.join(['.','tests','repos',target['commit_hash'], *(target['target_file_path'].split('/'))]))

        os.chdir(BASEDIR)

        with open('target_paths'+('' if k==1 else str(i))+'.json','w') as fp:
            json.dump(paths, fp, indent=4)

if __name__ == '__main__':
    argh.dispatch_command(get_repos)